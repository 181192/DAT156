<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Uke 3 - Veien mot skyene | DAT156</title>
    <meta name="description" content="Praksis i arbeidslivet for data @ stacc">
    
    
    <link rel="preload" href="/DAT156/assets/css/0.styles.91ee3f57.css" as="style"><link rel="preload" href="/DAT156/assets/js/app.36bcd4de.js" as="script"><link rel="preload" href="/DAT156/assets/js/7.df49b9c9.js" as="script"><link rel="prefetch" href="/DAT156/assets/js/2.61e37658.js"><link rel="prefetch" href="/DAT156/assets/js/3.003f1804.js"><link rel="prefetch" href="/DAT156/assets/js/4.930883f7.js"><link rel="prefetch" href="/DAT156/assets/js/5.d75c9b5f.js"><link rel="prefetch" href="/DAT156/assets/js/6.5cb7d4d1.js"><link rel="prefetch" href="/DAT156/assets/js/8.7170c154.js"><link rel="prefetch" href="/DAT156/assets/js/9.75ba2203.js">
    <link rel="stylesheet" href="/DAT156/assets/css/0.styles.91ee3f57.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/DAT156/" class="home-link router-link-active"><!----> <span class="site-name">DAT156</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/DAT156/" class="nav-link">Hjem</a></div><div class="nav-item"><a href="https://github.com/181192/DAT156" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://stacc.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Stacc
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/DAT156/" class="nav-link">Hjem</a></div><div class="nav-item"><a href="https://github.com/181192/DAT156" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://stacc.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Stacc
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/DAT156/uke4/" class="sidebar-link">Uke 4 - Dypt inn i skyene</a></li><li><a href="/DAT156/uke3/" class="active sidebar-link">Uke 3 - Veien mot skyene</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DAT156/uke3/#fredag" class="sidebar-link">Fredag</a></li><li class="sidebar-sub-header"><a href="/DAT156/uke3/#torsdag" class="sidebar-link">Torsdag</a></li><li class="sidebar-sub-header"><a href="/DAT156/uke3/#onsdag" class="sidebar-link">Onsdag</a></li><li class="sidebar-sub-header"><a href="/DAT156/uke3/#mandag-og-tirsdag" class="sidebar-link">Mandag og tirsdag</a></li></ul></li><li><a href="/DAT156/uke2/" class="sidebar-link">Uke 2 - Postman, Azure og Kubernetes</a></li><li><a href="/DAT156/uke1/" class="sidebar-link">Uke 1 - Vue og AngularJS</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="uke-3-veien-mot-skyene"><a href="#uke-3-veien-mot-skyene" aria-hidden="true" class="header-anchor">#</a> Uke 3 - Veien mot skyene</h1> <div class="tip custom-block"><p class="custom-block-title">Timer</p> <p>Denne uken: 26 (syk to dager)</p> <p><strong>Totalt: 93</strong> üéâ</p></div> <p></p><div class="table-of-contents"><ul><li><a href="#fredag">Fredag</a><ul><li><a href="#ulike-nivaer-av-monitorering">Ulike niv√•er av monitorering</a></li><li><a href="#prometheus-og-grafana">Prometheus og Grafana</a></li><li><a href="#jmx-exporter-java-agent-og-premain">JMX Exporter, Java Agent og premain</a></li><li><a href="#kubernetes-og-prometheus">Kubernetes og Prometheus</a></li><li><a href="#videre">Videre</a></li></ul></li><li><a href="#torsdag">Torsdag</a></li><li><a href="#onsdag">Onsdag</a></li><li><a href="#mandag-og-tirsdag">Mandag og tirsdag</a></li></ul></div><p></p> <h2 id="fredag"><a href="#fredag" aria-hidden="true" class="header-anchor">#</a> Fredag</h2> <p>I dag ble tiden brukt p√• √• se p√• monitorering av Kubernetes klusteret og Tomcat serveren som kj√∏rer applikasjonen.</p> <h3 id="ulike-nivaer-av-monitorering"><a href="#ulike-nivaer-av-monitorering" aria-hidden="true" class="header-anchor">#</a> Ulike niv√•er av monitorering</h3> <div class="warning custom-block"><p class="custom-block-title">Det er ulike niv√•er vi √∏nsker √• kunne monitorere og logge p√•:</p> <ol><li>Infrastruktur niv√•</li> <li>Kubernetes niv√•</li> <li>Tomcat / JVM niv√•</li> <li>Applikasjonsniv√•et</li></ol></div> <p>P√• infrastruktur niv√•et √∏nsker vi √• f√• informasjon om hvor mange ressurser vi har i Azure, som VM instanser og Kubernetes klustre.</p> <p>P√• Kubernetes niv√•et √∏nsker vi oversikt over blandt annet CPU, minnebruk, fillagring og nettverks bruk for selve klusteret. Men vi √∏nsker ogs√• detaljert informasjon om hver enkelt Pod.</p> <p>P√• Tomcat og JVM niv√•et √∏nsker vi detaljert informasjon om for eksempel hvor mange tr√•der som kj√∏rer, hvor mange feilmeldinger, telle antall foresp√∏rsler mot hvert enkelt REST-endpoint for eksempel <code>/location</code>, hvor mye minne JVM'en bruker.</p> <p>Og til slutt p√• Applikasjons laget s√• √∏nsker vi √• kunne analysere loggene, indeksere de, og kunne s√∏ke og prosessere loggene.</p> <h3 id="prometheus-og-grafana"><a href="#prometheus-og-grafana" aria-hidden="true" class="header-anchor">#</a> Prometheus og Grafana</h3> <p><a href="https://prometheus.io/" target="_blank" rel="noopener noreferrer">Prometheus<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> er et monitorerings system og en tidsseriedatabase. Prometheus er gode p√• dataer som man monitorerer, for eksempel CPU og minnebruk. For applikasjons logger, der vi m√• analysere innholdet m√• vi bruke andre alternativer som ELK-stacken (Elasticsearch). Det finnes ogs√• en mer lettvekt l√∏sning for logger til Prometheus ogs√•, <a href="https://github.com/grafana/loki" target="_blank" rel="noopener noreferrer">Loki<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, som er laget av Grafana.</p> <p><a href="https://grafana.com/" target="_blank" rel="noopener noreferrer">Grafana<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> er ett verkt√∏y for √• data visualisering og monitorering, som man bruker sammen med tjenester som Prometheus, Elasticsearch og InfluxDB.</p> <p>B√•de Kubernetes og Docker har innebygget st√∏tte for Prometheus, og med Kubernetes s√• vil Prometheus kunne oppdage tjenestene selv (self-discovering) som er sv√¶rt viktig n√•r ressursene i Kubernetes blir laget dynamisk.</p> <h3 id="jmx-exporter-java-agent-og-premain"><a href="#jmx-exporter-java-agent-og-premain" aria-hidden="true" class="header-anchor">#</a> JMX Exporter, Java Agent og <code>premain</code></h3> <p>For √• kunne monitorere Tomcat serveren vi m√• servere dataene til Prometheus over HTTP, og skal vi dra nytte av Kubernetes sin st√∏tte til Prometheus m√• monitorerings dataene bli servert p√• <code>/metrics</code>. Siden vi har mye eksisterende kode, er det n√∏dvendig √• finne en l√∏sning slik at vi kan monitorere applikasjone uten √• m√•tte endre den eksisterende kodebasen. Her kommer vi over Java Agent.</p> <div class="tip custom-block"><p class="custom-block-title">Java Agent</p> <p>En Java agent er en vanlig Java klasse med litt strengere regler, den m√• implementere metoden:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span>String agentArgs<span class="token punctuation">,</span> Instrumentation inst<span class="token punctuation">)</span>
</code></pre></div><p><code>premain</code> metoden blir en <em>agent entry point</em>, lignende den vanlige <code>main</code> vi er vandt med i vanlige Java applikasjoner.</p> <p>N√•r Java Virtuell Maskin (JVM) har blitt initialisert, vil hver <code>premain(String agentArgs, Instrumentation inst)</code> bli kalt i den rekkef√∏lgen agentene ble spesifisert n√•r JVM'en startet. N√•r alle <code>premain</code> metodene er initialisert vil den ekte Java applikasjon <code>main</code> metoden bli kalt.</p> <p>Med denne metoden kan man injisere og modifisere eksisterende kode, ved √• manipulere byte-koden. Her er det laget noen rammeverk, men i korte trekk blir det lagt til ekstra kode i for eksempel Interfacet <code>javax.servlet.Servlet</code>. Hvor vi da kan lytte p√• Servletene og telle for mange foresp√∏rsler det kommer til for eksempel <code>/eksempel</code>.</p></div> <h4 id="jmx-exporter"><a href="#jmx-exporter" aria-hidden="true" class="header-anchor">#</a> JMX Exporter</h4> <p>Prometheus har heldigvis laget en <a href="https://github.com/prometheus/jmx_exporter" target="_blank" rel="noopener noreferrer">JMX Exporter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> som kj√∏res som en Java Agent og serverer <em>metrics</em> p√• <code>url:port/metrics</code>, denne tar h√•nd om de fleste JVM m√•lingene vi er interessert i, og prosjektet ligger √•pen p√• GitHub s√• her kan vi ogs√• videre utvikle etter v√•rt eget behov.</p> <p>JMX Exporter prosjektet har ogs√• ett <a href="https://grafana.com/dashboards/3457" target="_blank" rel="noopener noreferrer">Grafana dashboard<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> som vi kan bruke til √• videre utvikle.</p> <h3 id="kubernetes-og-prometheus"><a href="#kubernetes-og-prometheus" aria-hidden="true" class="header-anchor">#</a> Kubernetes og Prometheus</h3> <p>Jeg kom over ett <a href="https://github.com/giantswarm/prometheus" target="_blank" rel="noopener noreferrer">Kubernetes oppsett for Prometheus og Grafana<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> som jeg kunne kjapt teste litt ut. M√•let her er at vi ogs√• skal kj√∏re Prometheus i selve Kubernetes klusteret.</p> <p>Prosjektet er satt opp med en fin <em>one-liner quick install</em> som setter opp alt under namespacet <code>monitoring</code> i det eksisterende klusteret v√•rt:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl apply \
  --filename https://raw.githubusercontent.com/giantswarm/kubernetes-prometheus/master/manifests-all.yaml
</code></pre></div><p>S√• kan vi videre sende porten inni klusteret til v√•r lokale maskin ved √• kj√∏re kommandoen:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl port-forward --namespace<span class="token operator">=</span>monitoring grafana-core 3000:3000
</code></pre></div><p>√Öpner vi <code>http://localhost:3000</code> p√• maskinen vil vi kunne se Grafana dashboardet</p> <h3 id="videre"><a href="#videre" aria-hidden="true" class="header-anchor">#</a> Videre</h3> <p>Jobben videre blir √• knytte sammen applikasjonen v√•r og Prometheus i Kubernetes klusteret. For √• f√• dette til m√• vi konfigurere Prometheus Annotations i Helm sin deployment fil. I metadata seksjonen under template i spec seksjonen m√• vi definere tre variabler:</p> <ul><li><code>prometheus.io/scrape</code>: Om Prometheus skal skrape Pod'en</li> <li><code>prometheus.io/path</code>: Hvilken sti <em>metrics</em> vil bli servert p√• (standard <code>/metrics</code>)</li> <li><code>prometheus.io/port</code>: Hvilken port Prometheus skal skrape p√•.</li></ul> <p>Neste uke, p√• mandag, skal jeg og ett par fra teamet mitt, samt Kubernetes eksperten fra tidligere i uken, ta et m√∏te for √• g√• igjennom og se hvor langt vi har kommet i prosjektet. Hva som gjenst√•r, hva som er gjort og hvor vi √∏nsker √• bevege oss videre.</p> <h2 id="torsdag"><a href="#torsdag" aria-hidden="true" class="header-anchor">#</a> Torsdag</h2> <p>Jeg fikk testet ut Azure Pipeline i dag. Sammenkoblingen mot ACR og AKS er smertefritt, alt er integrert i l√∏sninen via en grafisk pipeline bygger. Men jeg fikk ett stort problem, i v√•r l√∏sning med mono-repo og thrunk-based master er vi avhenging av <code>git tags</code> som versjonerer kodebasen etterhvert som Jenkins bygger prosjektet og byggingen blir vellyket. Denne metodikken √∏nsker vi √• fortsette med, siden vi da kan bruke taggen fra git til √• tagge docker imaget.</p> <p>Desverre st√∏tter ikke Azure Pipelines √• lese <code>git tags</code> fra Bitbucket, hvor vi hoster alle repositoriene v√•re. Azure Pipelines har muligheten dersom man bruker Azure DevOps egne repositories. Men vi kan ikke flytte alle v√•re repositories fra Bitbucket til Azure DevOps over natten, p√• grunn av vi bruker Jira og Confluence hos Atlassian. Skal vi g√• over, vil det generere en god del ekstra arbeid utennom dette prosjektet. Derfor g√•r jeg tilbake til Bitbucket Pipelines.</p> <p>Pipelinen min i Bitbucket deployer i siste steg til AKS. Vi skal bruke Kubernetes package manager'en Helm til √• deploye nye Docker images til klusteret. Dette var egentlig grunnen til at jeg ville pr√∏ve ut Azure Pipeline, fordi integrasjonen allerede var laget. S√• n√• m√• jeg sette det opp selv.</p> <p>Kubernetes eksperten fra i g√•r, hjalp meg med √• designe Helm Chartet for test applikasjonen v√•r.</p> <p>For √• kunne deploye til AKS med Helm trenger jeg noen verkt√∏y i Pipelinen min:</p> <ol><li><code>az</code> - Azure CLI for autentisering</li> <li><code>helm</code> - Helm klient for √• kunne oppdatere Helm Chartet</li> <li><code>kubectl</code> - Kubernetes CLI for √• kunne autentisere mot klusteret og sette riktig kontekst.</li></ol> <p>Dette l√∏ste jeg med √• lage ett eget Dockerimage som inneholder nettopp disse verkt√∏yene, som jeg kan importere i Pipelinen.</p> <div class="language-docker extra-class"><pre class="language-docker"><code><span class="token keyword">FROM</span> microsoft/azure<span class="token punctuation">-</span>cli

<span class="token keyword">ENV</span> KUBE_LATEST_VERSION=<span class="token string">&quot;v1.12.2&quot;</span>
<span class="token keyword">ENV</span> HELM_LATEST_VERSION=<span class="token string">&quot;v2.11.0&quot;</span>
<span class="token keyword">RUN</span> apk add <span class="token punctuation">-</span><span class="token punctuation">-</span>update ca<span class="token punctuation">-</span>certificates \
  &amp;&amp; apk add <span class="token punctuation">-</span><span class="token punctuation">-</span>update <span class="token punctuation">-</span>t deps curl \
  &amp;&amp; curl <span class="token punctuation">-</span>L https<span class="token punctuation">:</span>//storage.googleapis.com/kubernetes<span class="token punctuation">-</span>release/release/$<span class="token punctuation">{</span>KUBE_LATEST_VERSION<span class="token punctuation">}</span>/bin/linux/amd64/kubectl <span class="token punctuation">-</span>o /usr/local/bin/kubectl \
  &amp;&amp; chmod +x /usr/local/bin/kubectl \
  &amp;&amp; wget http<span class="token punctuation">:</span>//storage.googleapis.com/kubernetes<span class="token punctuation">-</span>helm/helm<span class="token punctuation">-</span>$<span class="token punctuation">{</span>HELM_LATEST_VERSION<span class="token punctuation">}</span><span class="token punctuation">-</span>linux<span class="token punctuation">-</span>amd64.tar.gz \
  &amp;&amp; tar <span class="token punctuation">-</span>xvf helm<span class="token punctuation">-</span>$<span class="token punctuation">{</span>HELM_LATEST_VERSION<span class="token punctuation">}</span><span class="token punctuation">-</span>linux<span class="token punctuation">-</span>amd64.tar.gz \
  &amp;&amp; mv linux<span class="token punctuation">-</span>amd64/helm /usr/local/bin \
  &amp;&amp; rm <span class="token punctuation">-</span>f /helm<span class="token punctuation">-</span>$<span class="token punctuation">{</span>HELM_LATEST_VERSION<span class="token punctuation">}</span><span class="token punctuation">-</span>linux<span class="token punctuation">-</span>amd64.tar.gz \
  &amp;&amp; apk del <span class="token punctuation">-</span><span class="token punctuation">-</span>purge deps \
  &amp;&amp; rm /var/cache/apk/*
</code></pre></div><p>Pipelinen ser etterp√• slik ut (fjernet noen verdier <code>&lt;variabel&gt;</code>):</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token key atrule">'*'</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">step</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> Build and deploy to Docker registry
          <span class="token key atrule">services</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> docker
          <span class="token key atrule">script</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> export IMAGE_NAME=$DOCKER_REGISTRY/$APP_NAME<span class="token punctuation">:</span>$BITBUCKET_TAG
            <span class="token punctuation">-</span> export IMAGE_NAME_LATEST=$DOCKER_REGISTRY/$APP_NAME<span class="token punctuation">:</span>latest
            <span class="token punctuation">-</span> docker build <span class="token punctuation">-</span>t $IMAGE_NAME <span class="token punctuation">-</span>t $IMAGE_NAME_LATEST .
            <span class="token punctuation">-</span> docker login &lt;registry_name<span class="token punctuation">&gt;</span>.azurecr.io <span class="token punctuation">-</span>u $DOCKER_USERNAME <span class="token punctuation">-</span><span class="token punctuation">-</span>password $DOCKER_PASSWORD
            <span class="token punctuation">-</span> docker push $IMAGE_NAME
            <span class="token punctuation">-</span> docker push $IMAGE_NAME_LATEST
      <span class="token punctuation">-</span> <span class="token key atrule">step</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy to Kubernetes
          <span class="token key atrule">deployment</span><span class="token punctuation">:</span> test
          <span class="token key atrule">image</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> &lt;registry_name<span class="token punctuation">&gt;</span>.azurecr.io/az<span class="token punctuation">-</span>cli<span class="token punctuation">-</span>kubectl<span class="token punctuation">-</span>helm<span class="token punctuation">:</span>0.1.1
            <span class="token key atrule">username</span><span class="token punctuation">:</span> $DOCKER_USERNAME
            <span class="token key atrule">password</span><span class="token punctuation">:</span> $DOCKER_PASSWORD
          <span class="token key atrule">script</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> az login <span class="token punctuation">-</span><span class="token punctuation">-</span>service<span class="token punctuation">-</span>principal <span class="token punctuation">-</span><span class="token punctuation">-</span>username $AZURE_CLIENT_ID <span class="token punctuation">-</span><span class="token punctuation">-</span>password $AZURE_SECRET <span class="token punctuation">-</span><span class="token punctuation">-</span>tenant $AZURE_TENANT <span class="token punctuation">-</span><span class="token punctuation">-</span>subscription $AZURE_SUBSCRIPTION_ID
            <span class="token punctuation">-</span> helm init <span class="token punctuation">-</span><span class="token punctuation">-</span>client<span class="token punctuation">-</span>only
            <span class="token punctuation">-</span> az acr helm repo add <span class="token punctuation">-</span>n &lt;registry_name<span class="token punctuation">&gt;</span>
            <span class="token punctuation">-</span> echo $KUBE_TOKEN <span class="token punctuation">|</span> base64 <span class="token punctuation">-</span>d <span class="token punctuation">&gt;</span> ./kube_token
            <span class="token punctuation">-</span> echo $KUBE_CA <span class="token punctuation">|</span> base64 <span class="token punctuation">-</span>d <span class="token punctuation">&gt;</span> ./kube_ca
            <span class="token punctuation">-</span> kubectl config set<span class="token punctuation">-</span>cluster &lt;cluster_name<span class="token punctuation">&gt;</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>server=$KUBERNETES_HOST <span class="token punctuation">-</span><span class="token punctuation">-</span>certificate<span class="token punctuation">-</span>authority=&quot;$(pwd)/kube_ca&quot;
            <span class="token punctuation">-</span> kubectl config set<span class="token punctuation">-</span>credentials bitbucket <span class="token punctuation">-</span><span class="token punctuation">-</span>token=&quot;$(cat ./kube_token)&quot;
            <span class="token punctuation">-</span> kubectl config set<span class="token punctuation">-</span>context development <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster=&lt;cluser_name<span class="token punctuation">&gt;</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>user=bitbucket
            <span class="token punctuation">-</span> kubectl config use<span class="token punctuation">-</span>context development
            <span class="token punctuation">-</span> helm upgrade $APP_NAME <span class="token punctuation">-</span><span class="token punctuation">-</span>install &lt;registry_name<span class="token punctuation">&gt;</span>/$APP_NAME <span class="token punctuation">-</span><span class="token punctuation">-</span>set image.tag=$BITBUCKET_TAG <span class="token punctuation">-</span><span class="token punctuation">-</span>namespace development
</code></pre></div><p>Planen i morgen er √• f√• oversikt over hvordan vi skal ta h√•nd om deployments som ikke er gyldige, Helm har innebygget funksjonalitet for √• kunne kj√∏re roll-back. Men det m√• ligge noe over for √• styre dette.</p> <p>Videre punkter som m√• unders√∏kes er logging, monitorering og sikkerhet b√•de for selve Kubernetes klusteret, Tomcat serveren som kj√∏rer inni containeren og Java applikasjonen.</p> <h2 id="onsdag"><a href="#onsdag" aria-hidden="true" class="header-anchor">#</a> Onsdag</h2> <p>I dag hadde jeg sammen med en kollega m√∏te med en Kubernetes ekspert fra firmaet som drifter mye av infrastrukturen til Stacc. Han skal hjelpe oss p√• veien med √• sette opp infrastrukturen rundt Kubernetes i <em>Veien mot skyene</em> prosjektet.</p> <p>Siden jeg forrige uke fikk satt opp Azure Container Registry med Ansibe kunne jeg i dag g√• videre p√• faktisk pushe Dockerimages til ACR.
Jeg fikk satt opp Bitbucket Pipeline til demo modulen v√•r, s√• n√•r det kommer en <code>git tag</code> vil pipelinen starte.</p> <p>Pipelinen best√•r av f√∏lgende:</p> <ol><li>Bygge et Dockerimage</li> <li>Deploye til Azure Container Registry</li> <li>Koble seg til Azure Kubernetes Service (AKS) via <code>kubectl</code></li> <li>Deploye Dockerimaget til Kubernetes klusteret (AKS)</li></ol> <p>Etter ett nytt m√∏te for √• diskutere stegene fremover, diskuterte vi litt om hva vi skal gj√∏re med delte biblioteker som i dag blir hostet inhouse via Nexus Repository. Disse vil ikke Bitbucket Pipeline f√• tilgang til. Derfor vurderer jeg n√• og se p√• Azure Artifacts, fordelen med at dette er en Azure tjeneste er mye tettere integrering med ACR og AKS, som blandt annet automatisk autentisering.</p> <p>Azure Artifacts er en undertjeneste i Azure DevOps, s√• det kan kanskje ogs√• v√¶re smart √• ta i bruk Azure Pipelines som ogs√• ligger i Azure DevOps n√•r muligheten ligger der.</p> <h2 id="mandag-og-tirsdag"><a href="#mandag-og-tirsdag" aria-hidden="true" class="header-anchor">#</a> Mandag og tirsdag</h2> <p>Syk</p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Sist oppdatert: </span> <span class="time">1/20/2019, 4:48:28 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ‚Üê
        <a href="/DAT156/uke4/" class="prev">
          Uke 4 - Dypt inn i skyene
        </a></span> <span class="next"><a href="/DAT156/uke2/">
          Uke 2 - Postman, Azure og Kubernetes
        </a>
        ‚Üí
      </span></p></div> </div> <!----></div></div>
    <script src="/DAT156/assets/js/app.36bcd4de.js" defer></script><script src="/DAT156/assets/js/7.df49b9c9.js" defer></script>
  </body>
</html>
