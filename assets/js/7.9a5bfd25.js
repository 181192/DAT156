(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{174:function(t,e,n){"use strict";n.r(e);var s=n(0),a=Object(s.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"uke-3-veien-mot-skyene"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#uke-3-veien-mot-skyene","aria-hidden":"true"}},[t._v("#")]),t._v(" Uke 3 - Veien mot skyene")]),t._v(" "),n("h2",{attrs:{id:"torsdag"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#torsdag","aria-hidden":"true"}},[t._v("#")]),t._v(" Torsdag")]),t._v(" "),n("p",[t._v("Jeg fikk testet ut Azure Pipeline i dag. Sammenkoblingen mot ACR og AKS er smertefritt, alt er integrert i løsninen via en grafisk pipeline bygger. Men jeg fikk ett stort problem, i vår løsning med mono-repo og thrunk-based master er vi avhenging av "),n("code",[t._v("git tags")]),t._v(" som versjonerer kodebasen etterhvert som Jenkins bygger prosjektet og byggingen blir vellyket. Denne metodikken ønsker vi å fortsette med, siden vi da kan bruke taggen fra git til å tagge docker imaget.")]),t._v(" "),n("p",[t._v("Desverre støtter ikke Azure Pipelines å lese "),n("code",[t._v("git tags")]),t._v(" fra Bitbucket, hvor vi hoster alle repositoriene våre. Azure Pipelines har muligheten dersom man bruker Azure DevOps egne repositories. Men vi kan ikke flytte alle våre repositories fra Bitbucket til Azure DevOps over natten, på grunn av vi bruker Jira og Confluence hos Atlassian. Skal vi gå over, vil det generere en god del ekstra arbeid utennom dette prosjektet. Derfor går jeg tilbake til Bitbucket Pipelines.")]),t._v(" "),n("p",[t._v("Pipelinen min i Bitbucket deployer i siste steg til AKS. Vi skal bruke Kubernetes package manager'en Helm til å deploye nye Docker images til klusteret. Dette var egentlig grunnen til at jeg ville prøve ut Azure Pipeline, fordi integrasjonen allerede var laget. Så nå må jeg sette det opp selv.")]),t._v(" "),n("p",[t._v("Kubernetes eksperten fra i går, hjalp meg med å designe Helm Chartet for test applikasjonen vår.")]),t._v(" "),n("p",[t._v("For å kunne deploye til AKS med Helm trenger jeg noen verktøy i Pipelinen min:")]),t._v(" "),n("ol",[n("li",[n("code",[t._v("az")]),t._v(" - Azure CLI for autentisering")]),t._v(" "),n("li",[n("code",[t._v("helm")]),t._v(" - Helm klient for å kunne oppdatere Helm Chartet")]),t._v(" "),n("li",[n("code",[t._v("kubectl")]),t._v(" - Kubernetes CLI for å kunne autentisere mot klusteret og sette riktig kontekst.")])]),t._v(" "),n("p",[t._v("Dette løste jeg med å lage ett eget Dockerimage som inneholder nettopp disse verktøyene, som jeg kan importere i Pipelinen.")]),t._v(" "),n("div",{staticClass:"language-docker extra-class"},[n("pre",{pre:!0,attrs:{class:"language-docker"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" microsoft/azure"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cli\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENV")]),t._v(" KUBE_LATEST_VERSION="),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"v1.12.2"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENV")]),t._v(" HELM_LATEST_VERSION="),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"v2.11.0"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" apk add "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("update ca"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("certificates \\\n  && apk add "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("update "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("t deps curl \\\n  && curl "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("L https"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//storage.googleapis.com/kubernetes"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("release/release/$"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("KUBE_LATEST_VERSION"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/bin/linux/amd64/kubectl "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("o /usr/local/bin/kubectl \\\n  && chmod +x /usr/local/bin/kubectl \\\n  && wget http"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//storage.googleapis.com/kubernetes"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("helm/helm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("$"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("HELM_LATEST_VERSION"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("linux"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("amd64.tar.gz \\\n  && tar "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("xvf helm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("$"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("HELM_LATEST_VERSION"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("linux"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("amd64.tar.gz \\\n  && mv linux"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("amd64/helm /usr/local/bin \\\n  && rm "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("f /helm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("$"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("HELM_LATEST_VERSION"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("linux"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("amd64.tar.gz \\\n  && apk del "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("purge deps \\\n  && rm /var/cache/apk/*\n")])])]),n("p",[t._v("Pipelinen ser etterpå slik ut (fjernet noen verdier "),n("code",[t._v("<variabel>")]),t._v("):")]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pipelines")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("'*'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("step")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Build and deploy to Docker registry\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" export IMAGE_NAME=$DOCKER_REGISTRY/$APP_NAME"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$BITBUCKET_TAG\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" export IMAGE_NAME_LATEST=$DOCKER_REGISTRY/$APP_NAME"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("latest\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker build "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("t $IMAGE_NAME "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("t $IMAGE_NAME_LATEST .\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker login <registry_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(".azurecr.io "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("u $DOCKER_USERNAME "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("password $DOCKER_PASSWORD\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker push $IMAGE_NAME\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker push $IMAGE_NAME_LATEST\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("step")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Deploy to Kubernetes\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deployment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" <registry_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(".azurecr.io/az"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cli"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("kubectl"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("helm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("0.1.1\n            "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("username")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $DOCKER_USERNAME\n            "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("password")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $DOCKER_PASSWORD\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" az login "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("service"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("principal "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("username $AZURE_CLIENT_ID "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("password $AZURE_SECRET "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("tenant $AZURE_TENANT "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("subscription $AZURE_SUBSCRIPTION_ID\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" helm init "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("client"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("only\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" az acr helm repo add "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("n <registry_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo $KUBE_TOKEN "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" base64 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("d "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" ./kube_token\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo $KUBE_CA "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" base64 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("d "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" ./kube_ca\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" kubectl config set"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cluster <cluster_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server=$KUBERNETES_HOST "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("certificate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('authority="$(pwd)/kube_ca"\n            '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" kubectl config set"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("credentials bitbucket "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('token="$(cat ./kube_token)"\n            '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" kubectl config set"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("context development "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cluster=<cluser_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("user=bitbucket\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" kubectl config use"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("context development\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" helm upgrade $APP_NAME "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("install <registry_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("/$APP_NAME "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("set image.tag=$BITBUCKET_TAG "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("namespace development\n")])])]),n("p",[t._v("Planen i morgen er å få oversikt over hvordan vi skal ta hånd om deployments som ikke er gyldige, Helm har innebygget funksjonalitet for å kunne kjøre roll-back. Men det må ligge noe over for å styre dette.")]),t._v(" "),n("p",[t._v("Videre punkter som må undersøkes er logging, monitorering og sikkerhet både for selve Kubernetes klusteret, Tomcat serveren som kjører inni containeren og Java applikasjonen.")]),t._v(" "),n("h2",{attrs:{id:"onsdag"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#onsdag","aria-hidden":"true"}},[t._v("#")]),t._v(" Onsdag")]),t._v(" "),n("p",[t._v("I dag hadde jeg sammen med en kollega møte med en Kubernetes ekspert fra firmaet som drifter mye av infrastrukturen til Stacc. Han skal hjelpe oss på veien med å sette opp infrastrukturen rundt Kubernetes i "),n("em",[t._v("Veien mot skyene")]),t._v(" prosjektet.")]),t._v(" "),n("p",[t._v("Siden jeg forrige uke fikk satt opp Azure Container Registry med Ansibe kunne jeg i dag gå videre på faktisk pushe Dockerimages til ACR.\nJeg fikk satt opp Bitbucket Pipeline til demo modulen vår, så når det kommer en "),n("code",[t._v("git tag")]),t._v(" vil pipelinen starte.")]),t._v(" "),n("p",[t._v("Pipelinen består av følgende:")]),t._v(" "),n("ol",[n("li",[t._v("Bygge et Dockerimage")]),t._v(" "),n("li",[t._v("Deploye til Azure Container Registry")]),t._v(" "),n("li",[t._v("Koble seg til Azure Kubernetes Service (AKS) via "),n("code",[t._v("kubectl")])]),t._v(" "),n("li",[t._v("Deploye Dockerimaget til Kubernetes klusteret (AKS)")])]),t._v(" "),n("p",[t._v("Etter ett nytt møte for å diskutere stegene fremover, diskuterte vi litt om hva vi skal gjøre med delte biblioteker som i dag blir hostet inhouse via Nexus Repository. Disse vil ikke Bitbucket Pipeline få tilgang til. Derfor vurderer jeg nå og se på Azure Artifacts, fordelen med at dette er en Azure tjeneste er mye tettere integrering med ACR og AKS, som blandt annet automatisk autentisering.")]),t._v(" "),n("p",[t._v("Azure Artifacts er en undertjeneste i Azure DevOps, så det kan kanskje også være smart å ta i bruk Azure Pipelines som også ligger i Azure DevOps når muligheten ligger der.")]),t._v(" "),n("h2",{attrs:{id:"mandag-og-tirsdag"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mandag-og-tirsdag","aria-hidden":"true"}},[t._v("#")]),t._v(" Mandag og tirsdag")]),t._v(" "),n("p",[t._v("Syk")])])}],!1,null,null,null);a.options.__file="README.md";e.default=a.exports}}]);