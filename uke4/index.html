<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Uke 4 - Dypt inn i skyene | DAT156</title>
    <meta name="description" content="Praksis i arbeidslivet for data @ stacc">
    
    
    <link rel="preload" href="/DAT156/assets/css/0.styles.91ee3f57.css" as="style"><link rel="preload" href="/DAT156/assets/js/app.96545799.js" as="script"><link rel="preload" href="/DAT156/assets/js/2.a4fa740c.js" as="script"><link rel="prefetch" href="/DAT156/assets/js/10.1e8caa56.js"><link rel="prefetch" href="/DAT156/assets/js/3.cd6fb8f1.js"><link rel="prefetch" href="/DAT156/assets/js/4.6ad881a4.js"><link rel="prefetch" href="/DAT156/assets/js/5.b346c63b.js"><link rel="prefetch" href="/DAT156/assets/js/6.71eb9d4c.js"><link rel="prefetch" href="/DAT156/assets/js/7.f281019f.js"><link rel="prefetch" href="/DAT156/assets/js/8.17dc28b3.js"><link rel="prefetch" href="/DAT156/assets/js/9.d0351bec.js">
    <link rel="stylesheet" href="/DAT156/assets/css/0.styles.91ee3f57.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/DAT156/" class="home-link router-link-active"><!----> <span class="site-name">DAT156</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/DAT156/" class="nav-link">Hjem</a></div><div class="nav-item"><a href="https://github.com/181192/DAT156" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://stacc.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Stacc
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/DAT156/" class="nav-link">Hjem</a></div><div class="nav-item"><a href="https://github.com/181192/DAT156" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://stacc.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Stacc
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/DAT156/uke5/" class="sidebar-link">Uke 5</a></li><li><a href="/DAT156/uke4/" class="active sidebar-link">Uke 4 - Dypt inn i skyene</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DAT156/uke4/#fredag" class="sidebar-link">Fredag</a></li><li class="sidebar-sub-header"><a href="/DAT156/uke4/#torsdag" class="sidebar-link">Torsdag</a></li><li class="sidebar-sub-header"><a href="/DAT156/uke4/#onsdag" class="sidebar-link">Onsdag</a></li><li class="sidebar-sub-header"><a href="/DAT156/uke4/#tirsdag" class="sidebar-link">Tirsdag</a></li><li class="sidebar-sub-header"><a href="/DAT156/uke4/#mandag" class="sidebar-link">Mandag</a></li></ul></li><li><a href="/DAT156/uke3/" class="sidebar-link">Uke 3 - Veien mot skyene</a></li><li><a href="/DAT156/uke2/" class="sidebar-link">Uke 2 - Postman, Azure og Kubernetes</a></li><li><a href="/DAT156/uke1/" class="sidebar-link">Uke 1 - Vue og AngularJS</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="uke-4-dypt-inn-i-skyene"><a href="#uke-4-dypt-inn-i-skyene" aria-hidden="true" class="header-anchor">#</a> Uke 4 - Dypt inn i skyene</h1> <div class="tip custom-block"><p class="custom-block-title">Timer</p> <p>Denne uken: 48</p> <p><strong>Totalt: 141</strong> üéâ</p></div> <p></p><div class="table-of-contents"><ul><li><a href="#fredag">Fredag</a></li><li><a href="#torsdag">Torsdag</a><ul><li><a href="#kort-om-bygge-prosessen-the-old-way">Kort om bygge prosessen &quot;the old way&quot;</a></li><li><a href="#kort-om-bygge-prosessen-for-biblioteker-og-parent-pom">Kort om bygge prosessen for biblioteker og parent POM</a></li><li><a href="#kort-om-bygge-prosessen-for-moduler">Kort om bygge prosessen for moduler</a></li></ul></li><li><a href="#onsdag">Onsdag</a></li><li><a href="#tirsdag">Tirsdag</a></li><li><a href="#mandag">Mandag</a></li></ul></div><p></p> <h2 id="fredag"><a href="#fredag" aria-hidden="true" class="header-anchor">#</a> Fredag</h2> <p>Jobbet i dag med √• implementere DNS st√∏tte til Kubernetes klusteret, slik at vi n√•r ressursene i klusteret via en URL istedet for via IP adresser som kan endre seg.</p> <p>Domenet som brukte tilh√∏rer egentlig Stacc Flow, men jeg kunne f√• sette opp en DNS oppf√∏ring som ser slik ut <code>*.insight.stacctest.com</code>,
denne DNS oppf√∏ringen inneholder ett <em>wildcard</em> som gj√∏r det slik vi kan enkelt ha mange milj√∏er opp mot dette domenet. Som for eksempel <code>beta.insight.stacctest.com</code> som da kan tilh√∏re v√•rt beta milj√∏.</p> <p>I Kubernetes klusteret for √• dra nytte av dette m√•tte jeg fjerne last balanseren og inf√∏re en Ingress kontroller. En Ingress er ett objekt i Kubernetes som lar oss koble oss til Kubernetes services utenfor klusteret. Ingress kontrolleren sender oss videre til en spesifikk tjeneste basert p√• regler.</p> <p><img src="/DAT156/assets/img/ingress.1c1a2b35.png" alt="ingress"></p> <p>Jeg holdt ogs√• en presentasjon om de nye Bitbucket Pipelines, hvordan konfigurere Maven til √• snakke med Azure Artifacts. Og kort om bygge prosessen mot Azure Artifacts, Azure Container Registry og Kubernetes.</p> <p>Presentasjonen inneholdt diagrammene fra g√•rsdagens innlegg. Jeg smekket i sammen en kjapp presentasjon med hjelp av <a href="https://github.com/hakimel/reveal.js/" target="_blank" rel="noopener noreferrer">reveal.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, ett HTML presentasjons rammeverk som kj√∏rer p√• Node.js, som jeg ogs√• da deployet til Kubernetes for √• demonstrere hvor langt prosjeket har kommet.</p> <h2 id="torsdag"><a href="#torsdag" aria-hidden="true" class="header-anchor">#</a> Torsdag</h2> <p>Etter floken i g√•r kveld, fikk jeg i dag deployet alle fem bibliotekene til Azure Artifacts og Bitbucket Pipelinen fungerer.
<code>dd_server_location</code> kan ogs√• n√• hente ut <code>paren POM</code> fra Azure Artifacts, s√• jeg kunne n√• lukke ett par del-saker i Jira knyttet til prosjeket.</p> <h3 id="kort-om-bygge-prosessen-the-old-way"><a href="#kort-om-bygge-prosessen-the-old-way" aria-hidden="true" class="header-anchor">#</a> Kort om bygge prosessen &quot;the old way&quot;</h3> <p>Utviklerne henter kode fra Bitbucket, kan bygge lokalt p√• maskinen for √• teste (henter artefakter fra Nexus internt). Jenkins sjekker repoet p√• bitbucket med jevne mellomrom. Er det nye endringer start Jenkins bygge prosessen. F√∏rst kloner den prosjektet, bygger det, utf√∏rer API tester og deployer ut til test milj√∏ene v√•re. Og lagrer alt som blir bygget i Nexus (jar-arkiver, war-arkiver, npm og Docker).</p> <p><img src="/DAT156/assets/img/jenkins.3d1db85b.png" alt="jenkins"></p> <h3 id="kort-om-bygge-prosessen-for-biblioteker-og-parent-pom"><a href="#kort-om-bygge-prosessen-for-biblioteker-og-parent-pom" aria-hidden="true" class="header-anchor">#</a> Kort om bygge prosessen for biblioteker og parent POM</h3> <p>Dette er den nye pipelinen for biblioteker (jar-arkiv) og parent POM'er.</p> <p>Utviklerne henter kode fra Bitbucket, og artefakter fra Azure Artifacts og evt Nexus.</p> <p>Nye moduler blir n√• bygget i Bitbucket Pipelines hver gang noen commiter. Byggingen bruker et spesielt docker bygg image, det blir ogs√• kj√∏rt tester. Det blir da laget en SNAPSHOT versjon som blir lastet opp p√• Azure Artifacts. N√•r det er tid for √• lage en release g√•r man inn p√• Bitbucket og trykker <em>release</em>, dette er noe som kan skrues av slik at det alltid blir deployet en release. Release versjonen blir ogs√• lastet opp p√• Azure Artifacts.</p> <p><img src="/DAT156/assets/img/artifacts.c0a26fd4.png" alt="artifacts"></p> <h3 id="kort-om-bygge-prosessen-for-moduler"><a href="#kort-om-bygge-prosessen-for-moduler" aria-hidden="true" class="header-anchor">#</a> Kort om bygge prosessen for moduler</h3> <p>Samme situasjon for utvikleren som i sted. Men siden vi fremdeles vil beholde testmilj√∏ene, og interne testingen mellom moduler, til alle modulene er deployet i Kubernetes bygges moduler p√• Jenkins.</p> <p>Det er f√∏rst n√•r Jenkins er ferdig og har tagget git loggen at Bitbucket Pipeline blir trigget. Da blir det bygget docker image, lastet opp til Azure Container Registry og Helm vil deploye det nye imaget til Kubernetes klusteret.</p> <p><img src="/DAT156/assets/img/kubernetes.f1a76a65.png" alt="kubernetes"></p> <h2 id="onsdag"><a href="#onsdag" aria-hidden="true" class="header-anchor">#</a> Onsdag</h2> <p>I dag har jeg fortsatt arbeidet med √• sette opp pipelines og f√• deployet noen av kjerne bibliotekene v√•re til Azure Artifacts.
N√•r jeg begynner √• flytte biblioteker opp i Bitbucket Pipeline og Azure Artifacts vil moduler som blir bygget p√• den interne Jenkins serveren som har avhengigheter mot artefakter som ligger i Azure Artifacts feile. Derfor m√•tte jeg oppdatere <code>settings.xml</code> til Jenkins serveren slik at den f√•r mulighet til √• laste ned artefakter fra Azure Artifacts.</p> <p>Etter litt mer knoting for √• fikse opp i avhengigheter og pr√∏ve √• deploye noe dro jeg hjem. N√•r jeg kom hjem var jeg litt irritert over at dette ikke gikk etter planen og satt meg ned igjen. Da oppdager jeg (se bilde nedenfor) at det er en loop av avhengigheter. Dette f√∏rer til at uansett hvilken modul jeg vil deploye er de avhengig av hverandre. Ingen kan eksistere uten hverandre.</p> <p><img src="/DAT156/assets/img/before-loop.cf3af81c.png" alt="before"></p> <p>Jeg rakk ut til en kollega som fremdeles var aktiv p√• Slack, og til min store lykke er det kollegaen som har gjort denne buggen. Han foresl√•r √• trekke ut koden <code>dd_core</code> bruker i <code>dd_test_util</code> (var bare en klasse) til en annen modul kalt <code>insight_utilities</code>. Resultatet ser du p√• bildet nedenfor.</p> <p><img src="/DAT156/assets/img/after-loop.2e9727be.png" alt="after"></p> <h2 id="tirsdag"><a href="#tirsdag" aria-hidden="true" class="header-anchor">#</a> Tirsdag</h2> <p>Jobbet i dag med Azure Artifacts og Bitbucket Pipelines. Planen er √• f√• deployet noen av kjerne bibliotekene vi bruker mest opp i Azure Artifacts. Jeg har pekt meg ut to biblioteker (en for backend og den andre for frontend) og en <em><code>parent pom.xml</code></em> som holder kontroll over versjonene av fleste Maven dependencies som er felles for mange av modulene.</p> <p>Jeg begynte med √• sette opp en <em>Feed</em> som det er kalt i Azure Artifacts. Denne <em>feed'en</em> kan man hente og publisere Maven artefaktene til. Det som kreves er at man definerer <code>&lt;servers&gt;</code> i <code>settings.xml</code> filen til Maven p√• maskinen, slik at Maven vil hente fra Azure Artifacts f√∏rst og ha fallback til Maven Central Repo. Deretter definerer man en repository inni <code>&lt;repositories&gt;</code> og <code>&lt;distributionManagment&gt;</code> taggene i <code>pom.xml</code> i prosjeket som skal benytte seg av artefaktene.</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>dev-azure-com-${company}-${feed}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://pkgs.dev.azure.com/${company}/_packaging/${feed}/maven/v1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>releases</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>releases</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Deretter begynte jeg med <em>Parent pom</em> prosjektet √• sette opp Bitbucket Pipeline. Det viste seg √• v√¶re mye problemer med √• f√• Maven Release plugin til √• fungere ordentlig. Slik Maven Release plugin fungerer bygger den prosjeket, laster opp en RELEASE artefakt til Azure Artifacs, commiter en ny versjon i <code>pom.xml</code> og tagger commiten med samme versjonsnummer. Deretter commiter den engang til for √• sette versjonen i <code>pom.xml</code> til en SNAPSHOT release. N√•r jeg f√∏rst satte igang fikk jeg ikke Maven Release plugin til √• commite, den feilet gang p√• gang.</p> <div class="danger custom-block"><p class="custom-block-title">Det var flere grunner til at det ikke fungerte</p> <ol><li>Bitbucket bruker en spesial SSH url for Bitbucket Pipelines som m√• settes med en milj√∏ variabel.</li> <li>Maven Release plugin bruker <code>git status --porcelain</code> til √• sjekke status. Den feiler √• lese output dersom milj√∏ variabelen <code>LANG</code> p√• maskinen ikke er satt til <code>en_US.UTF-8</code></li> <li>Maven kj√∏rer i docker, og er satt opp til at <code>settings.xml</code> filen m√• hete <code>settings-docker.xml</code> og ligge p√• <code>/usr/share/maven/ref/settings-docker.xml</code>.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>LANG<span class="token operator">=</span><span class="token string">'en_US.UTF-8'</span> mvn -B \
  -s /usr/share/maven/ref/settings-docker.xml \
  release:clean \
  release:prepare \
  release:perform \
  -Dbitbucket.url<span class="token operator">=</span><span class="token variable">${BITBUCKET_GIT_SSH_ORIGIN}</span>
</code></pre></div></div> <p>Slik ser git loggen ut etter en release:
<img src="/DAT156/assets/img/commits.234db6e8.png" alt="commits"></p> <h2 id="mandag"><a href="#mandag" aria-hidden="true" class="header-anchor">#</a> Mandag</h2> <p>I dag har jeg jobbet videre med √• f√• koblet sammen applikasjonen som kj√∏rer i Kubernetes klusteret og Prometheus. Utfordringen var √• f√• self-discovery funksjonaliteten til Prometheus til √• <em>scrape</em> applikasjonen v√•r p√• <code>&lt;url&gt;:8090/metrics</code>. Dette er viktig √• f√• til at den blir automatisk oppdaget, p√• grunn av n√•r man kj√∏rer applikasjoner i Kubernetes, kommer det til √• bli laget og fjernet kontainerer dynamisk ettersom Kubernetes klusteret skalerer etter behov. Da blir det umulig √• statisk konfigurere dette.</p> <p>Jeg fikk sammen med en kollega Prometheus til √• fungere, da brukte jeg litt tid p√• √• konfigurere ett par visualiseringer i Grafana. Prometheus har sitt eget sp√∏rrespr√•k for √• hente ut data, s√• her er det en del √• sette seg inn i.</p> <p>Jeg begynte ogs√• √• plukke opp tr√•den fra forrige uke med Azure Artifacts, vi er n√∏dt til √• fjerne oss med Nexus Repository hvor vi n√• lagrer artifacts som bibliotek <code>jar</code> filer og <code>pom.xml</code>. Fordi Nexus serveren kj√∏res p√• intern nettverket v√•rt, og vi √∏nsker ikke √• √•pne det opp. N√•r Azure Artifacts er oppe og kj√∏rer kan vi snart teste med flere moduler i klusteret.</p> <p>For √• kunne benytte seg av Azure Artifacts med Maven m√• det settes opp en <code>settings.xml</code> fil med autentisering mot selve repositoryet. Jeg vurderer √• lage et docker image for √• sette opp all konfigurasjonen, det samme som jeg gjorde med Azure- <code>kubectl</code>-og-Helm docker imaget. Da tar det mindre til √• sette opp flere pipelines i bitbucket.</p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Sist oppdatert: </span> <span class="time">1/25/2019, 10:04:30 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ‚Üê
        <a href="/DAT156/uke5/" class="prev">
          Uke 5
        </a></span> <span class="next"><a href="/DAT156/uke3/">
          Uke 3 - Veien mot skyene
        </a>
        ‚Üí
      </span></p></div> </div> <!----></div></div>
    <script src="/DAT156/assets/js/app.96545799.js" defer></script><script src="/DAT156/assets/js/2.a4fa740c.js" defer></script>
  </body>
</html>
